{% extends 'core/base.html' %}

{% block title %}Rooms | {% endblock %}

{% block content %} 
    <div class="mt-6 w-full flex flex-wrap items-start mx-3">

        <div class="lg:w-1/8 mt-6 mx-4 lg:mx-auto p-4 bg-white rounded-xl">
            <div class="space-y-3" >
                <p class="font-semibold">Online:</p>
                <div id="active-users">
                </div>
            </div>
        </div>
    
        <div class="flex-1">
            <div class="flex flex-wrap mx-3">
                {% for room in rooms %}
                    <div class="w-full lg:w-1/4 px-3 py-3">
                        <div class="p-4 bg-white shadow rounded-xl text-center">
                            <h2 class="mb-5 text-2xl font-semibold">{{ room.name }}</h2>
    
                            <a href="{% url 'room' room.slug %}" class="px-5 py-3 block rounded-xl text-white bg-slate-600 hover:bg-slate-700">Join</a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    
    </div>

{% endblock %}

{% block scripts %}

    <script> 
        const activeUsersSocket = new WebSocket(
          'ws://' 
          + window.location.host 
          + '/ws/users/active_users/'
        );
      
        function renderActiveUsers(activeUsers) {
          const activeUsersElement = document.getElementById('active-users');
          activeUsersElement.innerHTML = '';
          for (let i = 0; i < activeUsers.length; i++) {
            const userElement = document.createElement('div');
            userElement.className = 'p-4 mt-3 bg-gray-200 rounded-xl';
      
            const statusElement = document.createElement('div');
            statusElement.className = 'w-6 h-6 bg-green-400 rounded-full float-left';
      
            userElement.appendChild(statusElement);
            const usernameElement = document.createElement('div');
      
            usernameElement.className = 'font-semibold px-10';
            usernameElement.innerHTML = '<p>' + activeUsers[i] + '</p>';
      
            userElement.appendChild(usernameElement);
            activeUsersElement.appendChild(userElement);
          }
        }

        activeUsersSocket.onopen = function (e) {
            console.log('WebSocket connection opened.');
            const activeUsersElement = document.getElementById('active-users');
            activeUsersElement.innerHTML = '';

            activeUsersSocket.addEventListener('message', function (event) {
                const data = JSON.parse(event.data);
                if (data.type === 'active_users_update') {
                    renderActiveUsers(data.data);
                }
            });

            fetch('/rooms/users/active_users/')
                .then(response => response.json())
                .then(data => {
                    renderActiveUsers(data.active_users);
                })
                .catch(error => console.error(error));
        };
      
        activeUsersSocket.onclose = function (e) {
          console.log('WebSocket connection closed.');
        };

        // activeUsersSocket.onmessage = function (e) {
        //     const data = JSON.parse(e.data);
        //     if (data.type === 'active_users_update') {
        //         renderActiveUsers(data.data);
        //     }
        // };

    </script>
      

{% endblock %}